---
- name: Prepare stow directories
  ansible.builtin.file:
    path: "/home/{{ user }}/depot/"
    state: directory
    mode: '0755'
    owner: "{{ user }}"
- name: Check out dotfiles
  ansible.builtin.git:
    repo: https://github.com/wallner/dotfiles.git
    dest: "/home/{{ user }}/depot/dotfiles"
    version: main

- name: Run stow
  ansible.builtin.command: "stow --dir /home/{{ user }}/depot --target /home/{{ user }} dotfiles --verbose=2"
  register: result
  changed_when: 'result.stderr is search("LINK: ") or result.stderr is search("UNLINK: ")'

- name: Ensure .gemini directory exists
  ansible.builtin.file:
    path: "/home/{{ user }}/.gemini"
    state: directory
    mode: '0700'

- name: Deploy Gemini config (if missing)
  ansible.builtin.copy:
    dest: "/home/{{ user }}/.gemini/settings.json"
    force: false
    mode: '0644'
    content: |
      {
        "theme": "Default Light",
        "updateCheck": true
      }
- name: Fix permissions of .ssh/config
  ansible.builtin.file:
    path: "/home/{{ user }}/.ssh/config"
    mode: '0600'
- name: Generate the caches for 'bat'
  ansible.builtin.command: "bat cache --build"
  register: result
  changed_when: false

- name: Configure theme watcher service to start at login using systemd
  ansible.builtin.systemd_service:
    name: theme-watcher
    scope: user
    enabled: true
    state: started
